{
  "meta": {
    "generated_at": "2026-01-13T20:00:00.000000Z",
    "requirement_set": "req002",
    "purpose": "Logical architecture boundaries derived from requirements - implementation-agnostic",
    "rules_applied": [
      "No tech stack references",
      "No code concepts",
      "Only logical responsibilities",
      "Every component maps to requirements or journeys"
    ]
  },
  "actors": [
    {
      "id": "ACTOR-001",
      "name": "AI Agent",
      "description": "External system or script that invokes ailoop CLI commands to request human interaction",
      "interactions": [
        "Executes CLI commands (ask, authorize, say, image, navigate)",
        "Receives responses from human users",
        "May operate in direct mode or server mode"
      ],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-006", "JRN-007", "JRN-008"]
    },
    {
      "id": "ACTOR-002",
      "name": "Human User",
      "description": "Person who provides responses to questions, authorization decisions, or views notifications",
      "interactions": [
        "Provides responses in direct mode (local terminal)",
        "Monitors server terminal UI and provides responses in server mode",
        "Makes authorization decisions (authorized/denied)"
      ],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-008"]
    }
  ],
  "components": [
    {
      "id": "COMP-001",
      "name": "Mode Detection Component",
      "description": "Determines whether CLI commands should operate in direct mode or server mode based on configuration and environment",
      "responsibilities": [
        "Inspect command-line arguments for --server flag",
        "Inspect environment variables for AILOOP_SERVER",
        "Determine operation mode precedence (AILOOP_SERVER overrides --server flag)",
        "Provide mode decision to command handlers"
      ],
      "boundaries": {
        "provides": [
          "Mode decision (direct/server) to command handlers"
        ],
        "consumes": [
          "Command-line arguments",
          "Environment variables"
        ]
      },
      "related_requirements": ["REQ-001", "REQ-002", "REQ-003"],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003"]
    },
    {
      "id": "COMP-002",
      "name": "Direct Mode Handler",
      "description": "Handles CLI command execution when operating in direct mode - displays questions and collects responses in local terminal",
      "responsibilities": [
        "Display questions, authorization requests, or notifications in local terminal",
        "Collect user input from stdin",
        "Apply channel validation rules",
        "Apply timeout rules from configuration (if applicable)",
        "Format output (JSON or plain text based on --json flag)",
        "Handle cancellation (Ctrl+C) and timeout errors",
        "Exit with appropriate status codes"
      ],
      "boundaries": {
        "provides": [
          "User interaction in local terminal",
          "Formatted responses to AI agent"
        ],
        "consumes": [
          "Mode decision from Mode Detection Component",
          "Channel validation rules",
          "Configuration settings (timeout, JSON format)",
          "User input from stdin"
        ]
      },
      "related_requirements": ["REQ-002", "REQ-020", "REQ-021", "REQ-036"],
      "related_journeys": ["JRN-001"]
    },
    {
      "id": "COMP-003",
      "name": "Server Mode Client",
      "description": "Handles CLI command execution when operating in server mode - establishes WebSocket connections, sends messages, and receives responses",
      "responsibilities": [
        "Convert server URL from http/https to ws/wss protocol",
        "Establish WebSocket connection to server",
        "Create Message objects with unique correlation_id (UUID)",
        "Serialize Message to JSON format",
        "Send messages via WebSocket connection",
        "Wait for response messages with matching correlation_id",
        "Apply timeout rules from configuration (timeout_seconds > 0 or timeout_seconds = 0 for indefinite wait)",
        "Match received responses to pending requests using correlation_id",
        "Handle connection errors with clear error messages",
        "Handle timeout errors when waiting for response",
        "Format output (JSON or plain text based on --json flag)",
        "Exit with appropriate status codes",
        "Validate channel names before sending messages",
        "Validate server URL format before connection attempt"
      ],
      "boundaries": {
        "provides": [
          "WebSocket connection to server",
          "Message transmission to server",
          "Response reception from server",
          "Formatted responses to AI agent"
        ],
        "consumes": [
          "Mode decision from Mode Detection Component",
          "Server URL (from --server flag or AILOOP_SERVER env var)",
          "Configuration settings (timeout_seconds, JSON format)",
          "Channel validation rules"
        ]
      },
      "related_requirements": ["REQ-003", "REQ-004", "REQ-005", "REQ-006", "REQ-012", "REQ-013", "REQ-014", "REQ-016", "REQ-017", "REQ-018", "REQ-020", "REQ-021", "REQ-022", "REQ-023", "REQ-024", "REQ-025", "REQ-035", "REQ-036"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-006", "JRN-007", "JRN-008"]
    },
    {
      "id": "COMP-004",
      "name": "Server Mode Server",
      "description": "Handles incoming WebSocket connections, receives messages from clients, displays them to human users, and routes responses back to originating connections",
      "responsibilities": [
        "Accept WebSocket connections from clients",
        "Receive and deserialize Message objects from clients",
        "Validate message format and required fields",
        "Track mapping between incoming messages and originating WebSocket connections",
        "Enqueue messages in channel-specific queues",
        "Display queued messages to human users in terminal UI",
        "Collect human responses from terminal UI",
        "Create response Message objects with correlation_id matching original request",
        "Route response messages back to originating WebSocket connections using connection tracking",
        "Handle closed connections gracefully (do not send responses to closed connections)",
        "Maintain channel isolation (messages in different channels remain separate)",
        "Handle authorization decisions (authorized/denied) and create appropriate response types",
        "Handle notification messages (no response expected)"
      ],
      "boundaries": {
        "provides": [
          "WebSocket server endpoint",
          "Message reception from clients",
          "Message display to human users",
          "Response routing to clients"
        ],
        "consumes": [
          "Incoming WebSocket connections",
          "Human user input from terminal UI",
          "Channel isolation rules"
        ]
      },
      "related_requirements": ["REQ-007", "REQ-008", "REQ-009", "REQ-010", "REQ-011", "REQ-026", "REQ-028", "REQ-029", "REQ-030", "REQ-031"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-007"]
    },
    {
      "id": "COMP-005",
      "name": "Message Correlation Component",
      "description": "Manages correlation between request and response messages using correlation_id",
      "responsibilities": [
        "Generate globally unique correlation_id (UUID) for each request message",
        "Maintain mapping of pending requests keyed by correlation_id (client-side)",
        "Match response messages to pending requests using correlation_id",
        "Ensure correlation_id uniqueness across all messages",
        "Handle orphaned responses (correlation_id that doesn't match any pending request)"
      ],
      "boundaries": {
        "provides": [
          "Unique correlation_id generation",
          "Request-response matching capability"
        ],
        "consumes": [
          "Request messages (to generate correlation_id)",
          "Response messages (to match to requests)"
        ]
      },
      "related_requirements": ["REQ-005", "REQ-010", "REQ-012", "REQ-027", "REQ-034"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-007"]
    },
    {
      "id": "COMP-006",
      "name": "Connection Tracking Component",
      "description": "Maintains mapping between WebSocket connections and the messages they send, enabling response routing",
      "responsibilities": [
        "Record mapping between incoming message and originating WebSocket connection",
        "Maintain connection-to-message mappings until response is sent or connection closes",
        "Provide connection lookup for response routing",
        "Handle connection closure (remove mappings for closed connections)",
        "Ensure connection tracking information is not lost"
      ],
      "boundaries": {
        "provides": [
          "Connection-to-message mapping",
          "Connection lookup for response routing"
        ],
        "consumes": [
          "Incoming messages from WebSocket connections",
          "Connection lifecycle events (open, close)"
        ]
      },
      "related_requirements": ["REQ-007", "REQ-011", "REQ-028", "REQ-030"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-007"]
    },
    {
      "id": "COMP-007",
      "name": "Channel Management Component",
      "description": "Manages channel isolation and validation - ensures messages in different channels remain separate",
      "responsibilities": [
        "Validate channel names according to validation rules",
        "Maintain separate queues for each channel",
        "Ensure channel isolation (messages in channel A cannot access messages in channel B)",
        "Apply same channel validation rules in both direct mode and server mode",
        "Prevent messages from bypassing channel validation"
      ],
      "boundaries": {
        "provides": [
          "Channel validation",
          "Channel-specific message queues",
          "Channel isolation guarantee"
        ],
        "consumes": [
          "Channel names from messages",
          "Channel validation rules"
        ]
      },
      "related_requirements": ["REQ-008", "REQ-020", "REQ-029", "REQ-033"],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003", "JRN-004", "JRN-005"]
    },
    {
      "id": "COMP-008",
      "name": "Configuration Component",
      "description": "Manages configuration settings including timeout rules and output format preferences",
      "responsibilities": [
        "Read timeout_seconds from configuration file",
        "Provide timeout configuration to components that need it",
        "Support timeout_seconds = 0 (indefinite wait) and timeout_seconds > 0 (finite timeout)",
        "Maintain independent timeout logic for direct mode and server mode",
        "Read JSON output format preference (--json flag)"
      ],
      "boundaries": {
        "provides": [
          "Timeout configuration (timeout_seconds)",
          "Output format preference (JSON or plain text)"
        ],
        "consumes": [
          "Configuration file",
          "Command-line flags"
        ]
      },
      "related_requirements": ["REQ-016", "REQ-017", "REQ-018", "REQ-021", "REQ-036"],
      "related_journeys": ["JRN-008"]
    },
    {
      "id": "COMP-009",
      "name": "Error Handling Component",
      "description": "Handles errors and provides clear error messages to users",
      "responsibilities": [
        "Detect connection errors (server unreachable, network errors, handshake failures)",
        "Format connection error messages with URL and error type",
        "Detect timeout errors when waiting for server response",
        "Format timeout error messages",
        "Ensure error messages do not expose sensitive information (internal IPs, connection IDs, internal state)",
        "Prevent fallback to direct mode when server connection fails in server mode",
        "Exit with appropriate error codes (1 for errors, 0 for success)"
      ],
      "boundaries": {
        "provides": [
          "Error detection",
          "Formatted error messages",
          "Error exit codes"
        ],
        "consumes": [
          "Connection errors",
          "Timeout errors",
          "Validation errors"
        ]
      },
      "related_requirements": ["REQ-014", "REQ-018", "REQ-025", "REQ-032"],
      "related_journeys": ["JRN-006", "JRN-008"]
    },
    {
      "id": "COMP-010",
      "name": "Output Formatting Component",
      "description": "Formats command output consistently in both direct mode and server mode",
      "responsibilities": [
        "Generate JSON output format when --json flag is present",
        "Generate plain text output format when --json flag is absent",
        "Ensure JSON output structure and fields are identical in direct mode and server mode",
        "Format responses, authorization decisions, and notifications consistently"
      ],
      "boundaries": {
        "provides": [
          "Formatted output (JSON or plain text)",
          "Consistent output format across modes"
        ],
        "consumes": [
          "Response data",
          "Output format preference (from Configuration Component)"
        ]
      },
      "related_requirements": ["REQ-021"],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003", "JRN-004", "JRN-005"]
    }
  ],
  "interactions": [
    {
      "id": "INT-001",
      "name": "Mode Detection to Command Handler",
      "description": "Mode Detection Component provides mode decision to Direct Mode Handler or Server Mode Client",
      "from_component": "COMP-001",
      "to_component": ["COMP-002", "COMP-003"],
      "data_flow": "Mode decision (direct/server)",
      "related_requirements": ["REQ-001", "REQ-002", "REQ-003"]
    },
    {
      "id": "INT-002",
      "name": "Server Mode Client to Server Mode Server",
      "description": "Server Mode Client establishes WebSocket connection and sends messages to Server Mode Server",
      "from_component": "COMP-003",
      "to_component": ["COMP-004"],
      "data_flow": "WebSocket connection, Message objects (Question, Authorization, Notification)",
      "related_requirements": ["REQ-004", "REQ-005", "REQ-006", "REQ-007"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-007"]
    },
    {
      "id": "INT-003",
      "name": "Server Mode Server to Server Mode Client",
      "description": "Server Mode Server routes response messages back to originating Server Mode Client via WebSocket connection",
      "from_component": "COMP-004",
      "to_component": ["COMP-003"],
      "data_flow": "Response Message objects (Answer, AuthorizationApproved, AuthorizationDenied)",
      "related_requirements": ["REQ-010", "REQ-011", "REQ-012"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-007"]
    },
    {
      "id": "INT-004",
      "name": "Message Correlation in Client",
      "description": "Server Mode Client uses Message Correlation Component to generate correlation_id and match responses",
      "from_component": "COMP-003",
      "to_component": ["COMP-005"],
      "data_flow": "Request messages (for correlation_id generation), Response messages (for matching)",
      "related_requirements": ["REQ-005", "REQ-012"]
    },
    {
      "id": "INT-005",
      "name": "Message Correlation in Server",
      "description": "Server Mode Server uses Message Correlation Component to set correlation_id in response messages",
      "from_component": "COMP-004",
      "to_component": ["COMP-005"],
      "data_flow": "Request messages (to extract correlation_id), Response messages (to set correlation_id)",
      "related_requirements": ["REQ-010"]
    },
    {
      "id": "INT-006",
      "name": "Connection Tracking",
      "description": "Server Mode Server uses Connection Tracking Component to record and lookup connection-to-message mappings",
      "from_component": "COMP-004",
      "to_component": ["COMP-006"],
      "data_flow": "Incoming messages and connections (for recording), Response messages (for lookup)",
      "related_requirements": ["REQ-007", "REQ-011"]
    },
    {
      "id": "INT-007",
      "name": "Channel Management",
      "description": "Direct Mode Handler and Server Mode Client/Server use Channel Management Component for validation and isolation",
      "from_component": ["COMP-002", "COMP-003", "COMP-004"],
      "to_component": ["COMP-007"],
      "data_flow": "Channel names (for validation), Messages (for channel-specific queuing)",
      "related_requirements": ["REQ-008", "REQ-020", "REQ-029", "REQ-033"]
    },
    {
      "id": "INT-008",
      "name": "Configuration Access",
      "description": "Components access Configuration Component for timeout settings and output format preferences",
      "from_component": ["COMP-002", "COMP-003"],
      "to_component": ["COMP-008"],
      "data_flow": "Configuration requests, Timeout settings, Output format preferences",
      "related_requirements": ["REQ-016", "REQ-017", "REQ-018", "REQ-021", "REQ-036"]
    },
    {
      "id": "INT-009",
      "name": "Error Handling",
      "description": "Components use Error Handling Component to detect, format, and report errors",
      "from_component": ["COMP-003"],
      "to_component": ["COMP-009"],
      "data_flow": "Error events, Formatted error messages",
      "related_requirements": ["REQ-014", "REQ-018", "REQ-025", "REQ-032"]
    },
    {
      "id": "INT-010",
      "name": "Output Formatting",
      "description": "Direct Mode Handler and Server Mode Client use Output Formatting Component to format responses",
      "from_component": ["COMP-002", "COMP-003"],
      "to_component": ["COMP-010"],
      "data_flow": "Response data, Formatted output (JSON or plain text)",
      "related_requirements": ["REQ-021"]
    }
  ],
  "boundaries": [
    {
      "id": "BOUNDARY-001",
      "name": "Client-Server Boundary",
      "description": "Separation between CLI client components (running in AI agent's environment) and server components (running in ailoop serve instance)",
      "components_on_client_side": ["COMP-001", "COMP-002", "COMP-003", "COMP-005", "COMP-007", "COMP-008", "COMP-009", "COMP-010"],
      "components_on_server_side": ["COMP-004", "COMP-005", "COMP-006", "COMP-007"],
      "communication_protocol": "WebSocket (for server mode), Local terminal I/O (for direct mode)",
      "related_requirements": ["REQ-003", "REQ-004", "REQ-006", "REQ-007", "REQ-011", "REQ-012"],
      "related_journeys": ["JRN-002", "JRN-003", "JRN-004", "JRN-005", "JRN-007"]
    },
    {
      "id": "BOUNDARY-002",
      "name": "Mode Boundary",
      "description": "Separation between direct mode execution path and server mode execution path",
      "components_in_direct_mode": ["COMP-001", "COMP-002", "COMP-007", "COMP-008", "COMP-010"],
      "components_in_server_mode": ["COMP-001", "COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007", "COMP-008", "COMP-009", "COMP-010"],
      "mode_determination": "Mode Detection Component (COMP-001) determines which path to use",
      "related_requirements": ["REQ-001", "REQ-002", "REQ-003", "REQ-025"],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003"]
    },
    {
      "id": "BOUNDARY-003",
      "name": "Channel Isolation Boundary",
      "description": "Logical separation between different channels - messages in different channels cannot access each other",
      "enforced_by": "COMP-007",
      "applies_to": ["COMP-002", "COMP-003", "COMP-004"],
      "related_requirements": ["REQ-008", "REQ-029"],
      "related_journeys": ["JRN-001", "JRN-002", "JRN-003", "JRN-004", "JRN-005"]
    }
  ],
  "quality_attributes": [
    {
      "id": "QA-001",
      "name": "Backward Compatibility",
      "description": "Direct mode behavior must remain unchanged - existing CLI commands without --server flag and without AILOOP_SERVER env var must continue to work exactly as before",
      "affected_components": ["COMP-001", "COMP-002"],
      "related_requirements": ["REQ-002"]
    },
    {
      "id": "QA-002",
      "name": "Channel Isolation",
      "description": "Messages in different channels must remain completely separate - no cross-channel access",
      "affected_components": ["COMP-007", "COMP-004"],
      "related_requirements": ["REQ-008", "REQ-029"]
    },
    {
      "id": "QA-003",
      "name": "Response Correlation Integrity",
      "description": "Responses must always be correctly matched to their originating requests using correlation_id",
      "affected_components": ["COMP-005", "COMP-003", "COMP-004"],
      "related_requirements": ["REQ-005", "REQ-010", "REQ-012", "REQ-026", "REQ-027"]
    },
    {
      "id": "QA-004",
      "name": "Connection Routing Integrity",
      "description": "Responses must always be routed back to the originating WebSocket connection",
      "affected_components": ["COMP-006", "COMP-004"],
      "related_requirements": ["REQ-007", "REQ-011", "REQ-026", "REQ-028"]
    },
    {
      "id": "QA-005",
      "name": "Error Clarity",
      "description": "Error messages must be clear, actionable, and not expose sensitive internal information",
      "affected_components": ["COMP-009"],
      "related_requirements": ["REQ-014", "REQ-032"]
    },
    {
      "id": "QA-006",
      "name": "Output Consistency",
      "description": "JSON output format must be identical in both direct mode and server mode",
      "affected_components": ["COMP-010", "COMP-002", "COMP-003"],
      "related_requirements": ["REQ-021"]
    }
  ],
  "traceability": {
    "requirements_coverage": {
      "REQ-001": ["COMP-001"],
      "REQ-002": ["COMP-001", "COMP-002"],
      "REQ-003": ["COMP-001", "COMP-003"],
      "REQ-004": ["COMP-003"],
      "REQ-005": ["COMP-003", "COMP-005"],
      "REQ-006": ["COMP-003"],
      "REQ-007": ["COMP-004", "COMP-006"],
      "REQ-008": ["COMP-004", "COMP-007"],
      "REQ-009": ["COMP-004"],
      "REQ-010": ["COMP-004", "COMP-005"],
      "REQ-011": ["COMP-004", "COMP-006"],
      "REQ-012": ["COMP-003", "COMP-005"],
      "REQ-013": ["COMP-003"],
      "REQ-014": ["COMP-003", "COMP-009"],
      "REQ-016": ["COMP-003", "COMP-008"],
      "REQ-017": ["COMP-003", "COMP-008"],
      "REQ-018": ["COMP-003", "COMP-008", "COMP-009"],
      "REQ-020": ["COMP-002", "COMP-003", "COMP-007"],
      "REQ-021": ["COMP-002", "COMP-003", "COMP-010"],
      "REQ-022": ["COMP-003"],
      "REQ-023": ["COMP-003"],
      "REQ-024": ["COMP-003"],
      "REQ-025": ["COMP-003", "COMP-009"],
      "REQ-026": ["COMP-004", "COMP-006"],
      "REQ-027": ["COMP-005"],
      "REQ-028": ["COMP-006"],
      "REQ-029": ["COMP-004", "COMP-007"],
      "REQ-030": ["COMP-004", "COMP-006"],
      "REQ-031": ["COMP-004"],
      "REQ-032": ["COMP-009"],
      "REQ-033": ["COMP-003", "COMP-007"],
      "REQ-034": ["COMP-003", "COMP-005"],
      "REQ-035": ["COMP-003"],
      "REQ-036": ["COMP-002", "COMP-003", "COMP-008"]
    },
    "journey_coverage": {
      "JRN-001": ["COMP-001", "COMP-002", "COMP-007", "COMP-008", "COMP-010"],
      "JRN-002": ["COMP-001", "COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007", "COMP-008", "COMP-010"],
      "JRN-003": ["COMP-001", "COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007", "COMP-008", "COMP-010"],
      "JRN-004": ["COMP-001", "COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007", "COMP-008", "COMP-010"],
      "JRN-005": ["COMP-001", "COMP-003", "COMP-004", "COMP-007", "COMP-008", "COMP-010"],
      "JRN-006": ["COMP-001", "COMP-003", "COMP-009"],
      "JRN-007": ["COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007"],
      "JRN-008": ["COMP-003", "COMP-008", "COMP-009"]
    }
  }
}
