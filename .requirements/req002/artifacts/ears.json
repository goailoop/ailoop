{
  "requirements": [
    {
      "id": "REQ-001",
      "ears_type": "event",
      "statement": "WHEN AI agent executes any ailoop CLI command, system SHALL determine if command should operate in direct mode (no AILOOP_SERVER env var) or server mode (AILOOP_SERVER env var present).",
      "fields": {
        "trigger": "AI agent executes any ailoop CLI command",
        "condition": null,
        "state": null,
        "response": "Determine if command should operate in direct mode (no AILOOP_SERVER env var) or server mode (AILOOP_SERVER env var present)"
      }
    },
    {
      "id": "REQ-002",
      "ears_type": "event",
      "statement": "WHEN AI agent executes CLI command without AILOOP_SERVER environment variable, system SHALL operate in direct mode, displaying questions and collecting responses in local terminal.",
      "fields": {
        "trigger": "AI agent executes CLI command without AILOOP_SERVER environment variable",
        "condition": null,
        "state": null,
        "response": "Operate in direct mode, displaying questions and collecting responses in local terminal"
      }
    },
    {
      "id": "REQ-003",
      "ears_type": "event",
      "statement": "WHEN AI agent executes CLI command with AILOOP_SERVER environment variable set, system SHALL operate in server mode, connecting to server specified in AILOOP_SERVER via WebSocket and sending messages.",
      "fields": {
        "trigger": "AI agent executes CLI command with AILOOP_SERVER environment variable set",
        "condition": null,
        "state": null,
        "response": "Operate in server mode, connecting to server specified in AILOOP_SERVER via WebSocket and sending messages"
      }
    },
    {
      "id": "REQ-004",
      "ears_type": "event",
      "statement": "WHEN CLI command determines operation mode is server mode, system SHALL convert server URL from http/https to ws/wss protocol and establish WebSocket connection.",
      "fields": {
        "trigger": "CLI command determines operation mode is server mode",
        "condition": null,
        "state": null,
        "response": "Convert server URL from http/https to ws/wss protocol and establish WebSocket connection"
      }
    },
    {
      "id": "REQ-005",
      "ears_type": "event",
      "statement": "WHEN WebSocket client sends question, authorization, or notification message to server, system SHALL create Message object with globally unique correlation_id (UUID) to enable response matching.",
      "fields": {
        "trigger": "WebSocket client sends question, authorization, or notification message to server",
        "condition": null,
        "state": null,
        "response": "Create Message object with globally unique correlation_id (UUID) to enable response matching"
      }
    },
    {
      "id": "REQ-006",
      "ears_type": "event",
      "statement": "WHEN WebSocket client has created Message and established connection, system SHALL serialize Message to JSON and send via WebSocket connection to server.",
      "fields": {
        "trigger": "WebSocket client has created Message and established connection",
        "condition": null,
        "state": null,
        "response": "Serialize Message to JSON and send via WebSocket connection to server"
      }
    },
    {
      "id": "REQ-007",
      "ears_type": "event",
      "statement": "WHEN server receives Message from WebSocket client, system SHALL record mapping between incoming message and originating WebSocket connection for response routing.",
      "fields": {
        "trigger": "Server receives Message from WebSocket client",
        "condition": null,
        "state": null,
        "response": "Record mapping between incoming message and originating WebSocket connection for response routing"
      }
    },
    {
      "id": "REQ-008",
      "ears_type": "event",
      "statement": "WHEN server receives Message from WebSocket client, system SHALL add message to queue for the channel specified in message, maintaining channel isolation.",
      "fields": {
        "trigger": "Server receives Message from WebSocket client",
        "condition": null,
        "state": null,
        "response": "Add message to queue for the channel specified in message, maintaining channel isolation"
      }
    },
    {
      "id": "REQ-009",
      "ears_type": "event",
      "statement": "WHEN message is enqueued in server channel queue, system SHALL display message content (question, authorization request, or notification) in server terminal UI for human interaction.",
      "fields": {
        "trigger": "Message is enqueued in server channel queue",
        "condition": null,
        "state": null,
        "response": "Display message content (question, authorization request, or notification) in server terminal UI for human interaction"
      }
    },
    {
      "id": "REQ-010",
      "ears_type": "event",
      "statement": "WHEN human user provides response to question or authorization request in server terminal, system SHALL create response Message with correlation_id set to the id of the original request message.",
      "fields": {
        "trigger": "Human user provides response to question or authorization request in server terminal",
        "condition": null,
        "state": null,
        "response": "Create response Message with correlation_id set to the id of the original request message"
      }
    },
    {
      "id": "REQ-011",
      "ears_type": "event",
      "statement": "WHEN server creates response Message with correlation_id matching request, system SHALL use connection tracking to identify originating connection and send response via that connection.",
      "fields": {
        "trigger": "Server creates response Message with correlation_id matching request",
        "condition": null,
        "state": null,
        "response": "Use connection tracking to identify originating connection and send response via that connection"
      }
    },
    {
      "id": "REQ-012",
      "ears_type": "event",
      "statement": "WHEN WebSocket client receives response Message from server, system SHALL maintain a map of pending requests keyed by correlation_id and match response correlation_id to correct pending request using lookup.",
      "fields": {
        "trigger": "WebSocket client receives response Message from server",
        "condition": null,
        "state": null,
        "response": "Maintain a map of pending requests keyed by correlation_id and match response correlation_id to correct pending request using lookup"
      }
    },
    {
      "id": "REQ-013",
      "ears_type": "event",
      "statement": "WHEN WebSocket client sends question or authorization message to server, system SHALL wait for response Message from server with matching correlation_id subject to timeout rules (REQ-016/REQ-017).",
      "fields": {
        "trigger": "WebSocket client sends question or authorization message to server",
        "condition": null,
        "state": null,
        "response": "Wait for response Message from server with matching correlation_id subject to timeout rules (REQ-016/REQ-017)"
      }
    },
    {
      "id": "REQ-014",
      "ears_type": "event",
      "statement": "WHEN WebSocket client attempts to connect to server but connection fails, system SHALL display error message in format 'Failed to connect to server at {URL}: {error_type}. Ensure server is running and accessible.' and exit with error code 1, without falling back to direct mode.",
      "fields": {
        "trigger": "WebSocket client attempts to connect to server but connection fails",
        "condition": null,
        "state": null,
        "response": "Display error message in format 'Failed to connect to server at {URL}: {error_type}. Ensure server is running and accessible.' and exit with error code 1, without falling back to direct mode"
      }
    },
    {
      "id": "REQ-016",
      "ears_type": "complex",
      "statement": "WHEN WebSocket client waits for server response in server mode, IF configuration file timeout_seconds is greater than 0, system SHALL apply timeout_seconds from configuration file as maximum wait time for server response.",
      "fields": {
        "trigger": "WebSocket client waits for server response in server mode",
        "condition": "Configuration file timeout_seconds is greater than 0",
        "state": null,
        "response": "Apply timeout_seconds from configuration file as maximum wait time for server response"
      }
    },
    {
      "id": "REQ-017",
      "ears_type": "complex",
      "statement": "WHEN WebSocket client waits for server response in server mode, IF configuration file timeout_seconds is 0, system SHALL wait indefinitely for server response without timeout expiration.",
      "fields": {
        "trigger": "WebSocket client waits for server response in server mode",
        "condition": "Configuration file timeout_seconds is 0",
        "state": null,
        "response": "Wait indefinitely for server response without timeout expiration"
      }
    },
    {
      "id": "REQ-018",
      "ears_type": "event",
      "statement": "WHEN timeout expires while waiting for server response, system SHALL display timeout error message and exit with error code 1.",
      "fields": {
        "trigger": "Timeout expires while waiting for server response",
        "condition": null,
        "state": null,
        "response": "Display timeout error message and exit with error code 1"
      }
    },
    {
      "id": "REQ-020",
      "ears_type": "event",
      "statement": "WHEN AI agent executes CLI command with channel parameter, system SHALL apply same channel name validation rules regardless of operation mode.",
      "fields": {
        "trigger": "AI agent executes CLI command with channel parameter",
        "condition": null,
        "state": null,
        "response": "Apply same channel name validation rules regardless of operation mode"
      }
    },
    {
      "id": "REQ-021",
      "ears_type": "event",
      "statement": "WHEN AI agent executes CLI command with --json flag, system SHALL generate JSON output with same structure and fields regardless of operation mode.",
      "fields": {
        "trigger": "AI agent executes CLI command with --json flag",
        "condition": null,
        "state": null,
        "response": "Generate JSON output with same structure and fields regardless of operation mode"
      }
    },
    {
      "id": "REQ-022",
      "ears_type": "event",
      "statement": "WHEN AI agent executes 'ailoop ask' command in server mode, system SHALL send question to server, wait for human response subject to timeout rules, and return response to agent.",
      "fields": {
        "trigger": "AI agent executes 'ailoop ask' command in server mode",
        "condition": null,
        "state": null,
        "response": "Send question to server, wait for human response subject to timeout rules, and return response to agent"
      }
    },
    {
      "id": "REQ-023",
      "ears_type": "event",
      "statement": "WHEN AI agent executes 'ailoop authorize' command in server mode, system SHALL send authorization request to server, wait for human decision subject to timeout rules, and return approval/denial to agent.",
      "fields": {
        "trigger": "AI agent executes 'ailoop authorize' command in server mode",
        "condition": null,
        "state": null,
        "response": "Send authorization request to server, wait for human decision subject to timeout rules, and return approval/denial to agent"
      }
    },
    {
      "id": "REQ-024",
      "ears_type": "event",
      "statement": "WHEN AI agent executes 'ailoop say' command in server mode, system SHALL send notification message to server and complete immediately without waiting for response.",
      "fields": {
        "trigger": "AI agent executes 'ailoop say' command in server mode",
        "condition": null,
        "state": null,
        "response": "Send notification message to server and complete immediately without waiting for response"
      }
    }
  ],
  "issues": []
}