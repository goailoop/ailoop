{
  "meta": {
    "generated_at": "2026-01-13T20:10:00.000000Z",
    "requirement_set": "req002",
    "purpose": "Canonical entities and invariants derived from requirements - logical schema only",
    "rules_applied": [
      "Logical schema only",
      "No database or storage design",
      "Use glossary terms"
    ]
  },
  "entities": [
    {
      "id": "ENTITY-001",
      "name": "Message",
      "description": "Represents a communication unit exchanged between AI agents and human users. Messages can be questions, authorization requests, notifications, or responses.",
      "glossary_terms": ["Message Correlation", "Correlation ID", "Request-Response Cycle"],
      "attributes": [
        {
          "name": "id",
          "type": "string",
          "format": "UUID",
          "description": "Unique identifier for the message",
          "required": true,
          "immutable": true
        },
        {
          "name": "correlation_id",
          "type": "string",
          "format": "UUID",
          "description": "Unique identifier linking response messages to their originating request messages. Used for routing responses back to correct WebSocket connections.",
          "required": true,
          "immutable": true,
          "invariant": "Must be globally unique across all messages"
        },
        {
          "name": "message_type",
          "type": "enum",
          "values": ["Question", "Authorization", "Notification", "Answer", "AuthorizationApproved", "AuthorizationDenied"],
          "description": "Type of message",
          "required": true,
          "immutable": true
        },
        {
          "name": "channel",
          "type": "string",
          "description": "Channel name for message isolation. Must be validated according to channel validation rules.",
          "required": true,
          "immutable": true,
          "default": "public",
          "invariant": "Must pass channel name validation rules"
        },
        {
          "name": "content",
          "type": "string",
          "description": "Message content (question text, action description, notification text, answer text, or authorization decision)",
          "required": true,
          "immutable": false
        },
        {
          "name": "priority",
          "type": "enum",
          "values": ["low", "normal", "high"],
          "description": "Priority level (for Notification messages)",
          "required": false,
          "immutable": true,
          "default": "normal"
        },
        {
          "name": "timeout_seconds",
          "type": "integer",
          "description": "Timeout in seconds (for Authorization messages). 0 means wait indefinitely.",
          "required": false,
          "immutable": true,
          "default": 0,
          "invariant": "Must be >= 0"
        },
        {
          "name": "created_at",
          "type": "timestamp",
          "description": "Timestamp when message was created",
          "required": true,
          "immutable": true
        }
      ],
      "invariants": [
        "correlation_id must be globally unique across all messages (REQ-027)",
        "channel must pass validation rules (REQ-020, REQ-033)",
        "For response messages (Answer, AuthorizationApproved, AuthorizationDenied), correlation_id must match an existing request message",
        "For request messages (Question, Authorization, Notification), correlation_id is generated at creation time",
        "timeout_seconds must be >= 0 (0 means indefinite wait per REQ-017)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "created",
            "description": "Message created with correlation_id"
          },
          {
            "state": "sent",
            "description": "Message sent to server (server mode) or displayed to user (direct mode)"
          },
          {
            "state": "queued",
            "description": "Message enqueued in channel queue (server mode only)"
          },
          {
            "state": "displayed",
            "description": "Message displayed to human user in terminal UI (server mode only)"
          },
          {
            "state": "responded",
            "description": "Response message created with matching correlation_id (for request messages)"
          },
          {
            "state": "completed",
            "description": "Message processing completed"
          }
        ],
        "transitions": [
          {
            "from": "created",
            "to": "sent",
            "trigger": "Message sent via WebSocket (server mode) or displayed in terminal (direct mode)"
          },
          {
            "from": "sent",
            "to": "queued",
            "trigger": "Message received by server and enqueued in channel queue (server mode only)"
          },
          {
            "from": "queued",
            "to": "displayed",
            "trigger": "Message displayed in server terminal UI (server mode only)"
          },
          {
            "from": "displayed",
            "to": "responded",
            "trigger": "Human user provides response, response message created with matching correlation_id"
          },
          {
            "from": "responded",
            "to": "completed",
            "trigger": "Response received by client and processing completed"
          }
        ]
      },
      "relationships": [
        {
          "type": "belongs_to",
          "target": "Channel",
          "via": "channel",
          "description": "Message belongs to a channel for isolation"
        },
        {
          "type": "correlates_with",
          "target": "Message",
          "via": "correlation_id",
          "description": "Response messages correlate with request messages via correlation_id"
        }
      ],
      "related_requirements": ["REQ-005", "REQ-006", "REQ-008", "REQ-010", "REQ-012", "REQ-020", "REQ-027", "REQ-033"],
      "related_interfaces": ["IF-006", "IF-007", "IF-010", "IF-011", "IF-013", "IF-014"]
    },
    {
      "id": "ENTITY-002",
      "name": "Connection",
      "description": "Represents a WebSocket connection between a CLI client and the server. Tracks connection state and enables response routing.",
      "glossary_terms": ["WebSocket Client", "Connection Tracking", "Response Routing"],
      "attributes": [
        {
          "name": "connection_id",
          "type": "string",
          "format": "UUID",
          "description": "Unique identifier for the WebSocket connection",
          "required": true,
          "immutable": true
        },
        {
          "name": "server_url",
          "type": "string",
          "description": "Server URL (converted from http/https to ws/wss protocol)",
          "required": true,
          "immutable": true,
          "invariant": "Must be valid WebSocket URL (ws:// or wss://)"
        },
        {
          "name": "state",
          "type": "enum",
          "values": ["establishing", "connected", "closed"],
          "description": "Current state of the connection",
          "required": true,
          "immutable": false
        },
        {
          "name": "established_at",
          "type": "timestamp",
          "description": "Timestamp when connection was established",
          "required": false,
          "immutable": true
        },
        {
          "name": "closed_at",
          "type": "timestamp",
          "description": "Timestamp when connection was closed",
          "required": false,
          "immutable": true
        }
      ],
      "invariants": [
        "connection_id must be unique",
        "When state is 'connected', established_at must be set",
        "When state is 'closed', closed_at must be set and closed_at >= established_at",
        "server_url must be valid WebSocket URL format (ws:// or wss://)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "establishing",
            "description": "Connection attempt in progress"
          },
          {
            "state": "connected",
            "description": "Connection established and active"
          },
          {
            "state": "closed",
            "description": "Connection closed (by client or server)"
          }
        ],
        "transitions": [
          {
            "from": "establishing",
            "to": "connected",
            "trigger": "WebSocket handshake successful"
          },
          {
            "from": "establishing",
            "to": "closed",
            "trigger": "Connection attempt failed"
          },
          {
            "from": "connected",
            "to": "closed",
            "trigger": "Connection closed by client or server"
          }
        ]
      },
      "relationships": [
        {
          "type": "has_many",
          "target": "ConnectionMapping",
          "via": "connection_id",
          "description": "Connection has multiple message mappings for response routing"
        }
      ],
      "related_requirements": ["REQ-004", "REQ-007", "REQ-011", "REQ-014", "REQ-028", "REQ-030"],
      "related_interfaces": ["IF-005", "IF-009", "IF-012", "IF-015", "IF-016", "IF-017"]
    },
    {
      "id": "ENTITY-003",
      "name": "ConnectionMapping",
      "description": "Maps incoming messages to their originating WebSocket connections, enabling response routing back to correct connections.",
      "glossary_terms": ["Connection Tracking", "Response Routing"],
      "attributes": [
        {
          "name": "mapping_id",
          "type": "string",
          "format": "UUID",
          "description": "Unique identifier for the mapping",
          "required": true,
          "immutable": true
        },
        {
          "name": "connection_id",
          "type": "string",
          "format": "UUID",
          "description": "Identifier of WebSocket connection that sent the message",
          "required": true,
          "immutable": true
        },
        {
          "name": "message_id",
          "type": "string",
          "format": "UUID",
          "description": "Identifier of the message",
          "required": true,
          "immutable": true
        },
        {
          "name": "correlation_id",
          "type": "string",
          "format": "UUID",
          "description": "Correlation identifier of the message (for lookup)",
          "required": true,
          "immutable": true
        },
        {
          "name": "created_at",
          "type": "timestamp",
          "description": "Timestamp when mapping was created",
          "required": true,
          "immutable": true
        }
      ],
      "invariants": [
        "mapping_id must be unique",
        "connection_id must reference an existing Connection",
        "message_id must reference an existing Message",
        "correlation_id must match the message's correlation_id",
        "Mapping must be removed when connection closes or response is sent (REQ-028, REQ-030)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "active",
            "description": "Mapping is active and can be used for response routing"
          },
          {
            "state": "removed",
            "description": "Mapping removed (connection closed or response sent)"
          }
        ],
        "transitions": [
          {
            "from": "active",
            "to": "removed",
            "trigger": "Connection closed or response sent"
          }
        ]
      },
      "relationships": [
        {
          "type": "belongs_to",
          "target": "Connection",
          "via": "connection_id",
          "description": "Mapping belongs to a connection"
        },
        {
          "type": "references",
          "target": "Message",
          "via": "message_id",
          "description": "Mapping references a message"
        }
      ],
      "related_requirements": ["REQ-007", "REQ-011", "REQ-026", "REQ-028", "REQ-030"],
      "related_interfaces": ["IF-015", "IF-016", "IF-017"]
    },
    {
      "id": "ENTITY-004",
      "name": "Channel",
      "description": "Represents an isolated communication pathway. Messages in different channels remain completely separate.",
      "glossary_terms": ["Channel Isolation", "Message Queue"],
      "attributes": [
        {
          "name": "name",
          "type": "string",
          "description": "Channel identifier (primary key). Must pass validation rules.",
          "required": true,
          "immutable": true,
          "invariant": "Must match channel name validation pattern"
        },
        {
          "name": "created_at",
          "type": "timestamp",
          "description": "Timestamp when channel was first used",
          "required": true,
          "immutable": true
        }
      ],
      "invariants": [
        "name must be unique",
        "name must pass channel validation rules (REQ-020, REQ-033)",
        "Messages in different channels must remain isolated (REQ-008, REQ-029)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "active",
            "description": "Channel is active and can receive messages"
          }
        ],
        "transitions": []
      },
      "relationships": [
        {
          "type": "has_many",
          "target": "Message",
          "via": "channel",
          "description": "Channel contains multiple messages"
        },
        {
          "type": "has_one",
          "target": "ChannelQueue",
          "via": "name",
          "description": "Channel has a message queue (server mode only)"
        }
      ],
      "related_requirements": ["REQ-008", "REQ-020", "REQ-029", "REQ-033"],
      "related_interfaces": ["IF-018", "IF-019", "IF-020"]
    },
    {
      "id": "ENTITY-005",
      "name": "ChannelQueue",
      "description": "Server-side queue holding incoming messages from WebSocket clients before they are processed and displayed to human users.",
      "glossary_terms": ["Message Queue"],
      "attributes": [
        {
          "name": "channel_name",
          "type": "string",
          "description": "Channel name this queue belongs to",
          "required": true,
          "immutable": true
        },
        {
          "name": "messages",
          "type": "array",
          "description": "Ordered list of messages in the queue (FIFO)",
          "required": true,
          "immutable": false,
          "items": {
            "type": "reference",
            "target": "Message"
          }
        }
      ],
      "invariants": [
        "channel_name must reference an existing Channel",
        "Messages must be ordered by enqueue time (FIFO)",
        "Messages in queue must belong to the same channel (REQ-008, REQ-029)",
        "Queue maintains channel isolation (REQ-029)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "active",
            "description": "Queue is active and can receive messages"
          }
        ],
        "transitions": []
      },
      "relationships": [
        {
          "type": "belongs_to",
          "target": "Channel",
          "via": "channel_name",
          "description": "Queue belongs to a channel"
        },
        {
          "type": "contains",
          "target": "Message",
          "via": "messages",
          "description": "Queue contains multiple messages"
        }
      ],
      "related_requirements": ["REQ-008", "REQ-009", "REQ-029"],
      "related_interfaces": ["IF-019", "IF-020"]
    },
    {
      "id": "ENTITY-006",
      "name": "PendingRequest",
      "description": "Client-side tracking of requests waiting for responses. Used to match incoming responses to their originating requests.",
      "glossary_terms": ["Message Correlation", "Request-Response Cycle"],
      "attributes": [
        {
          "name": "correlation_id",
          "type": "string",
          "format": "UUID",
          "description": "Correlation identifier of the pending request",
          "required": true,
          "immutable": true
        },
        {
          "name": "connection_id",
          "type": "string",
          "format": "UUID",
          "description": "Connection identifier where request was sent",
          "required": true,
          "immutable": true
        },
        {
          "name": "message_type",
          "type": "enum",
          "values": ["Question", "Authorization"],
          "description": "Type of pending request",
          "required": true,
          "immutable": true
        },
        {
          "name": "sent_at",
          "type": "timestamp",
          "description": "Timestamp when request was sent",
          "required": true,
          "immutable": true
        },
        {
          "name": "timeout_seconds",
          "type": "integer",
          "description": "Timeout in seconds (0 means wait indefinitely)",
          "required": true,
          "immutable": true,
          "default": 0,
          "invariant": "Must be >= 0"
        }
      ],
      "invariants": [
        "correlation_id must be unique across all pending requests",
        "correlation_id must match the message's correlation_id",
        "timeout_seconds must be >= 0 (0 means indefinite wait per REQ-017)",
        "Pending request must be removed when response is received or timeout expires"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "pending",
            "description": "Request sent, waiting for response"
          },
          {
            "state": "matched",
            "description": "Response received and matched"
          },
          {
            "state": "timeout",
            "description": "Timeout expired before response received"
          },
          {
            "state": "cancelled",
            "description": "Request cancelled (connection closed)"
          }
        ],
        "transitions": [
          {
            "from": "pending",
            "to": "matched",
            "trigger": "Response received with matching correlation_id"
          },
          {
            "from": "pending",
            "to": "timeout",
            "trigger": "Timeout expired (if timeout_seconds > 0)"
          },
          {
            "from": "pending",
            "to": "cancelled",
            "trigger": "Connection closed"
          }
        ]
      },
      "relationships": [
        {
          "type": "references",
          "target": "Message",
          "via": "correlation_id",
          "description": "Pending request references a message"
        },
        {
          "type": "belongs_to",
          "target": "Connection",
          "via": "connection_id",
          "description": "Pending request belongs to a connection"
        }
      ],
      "related_requirements": ["REQ-012", "REQ-013", "REQ-016", "REQ-017", "REQ-018", "REQ-034"],
      "related_interfaces": ["IF-007", "IF-008", "IF-014"]
    },
    {
      "id": "ENTITY-007",
      "name": "Configuration",
      "description": "Configuration settings including timeout rules and output format preferences. Maintains independent settings for direct mode and server mode.",
      "glossary_terms": ["Response Timeout", "JSON Output Format"],
      "attributes": [
        {
          "name": "timeout_seconds_direct",
          "type": "integer",
          "description": "Timeout in seconds for direct mode (0 means wait indefinitely)",
          "required": true,
          "immutable": false,
          "default": 0,
          "invariant": "Must be >= 0"
        },
        {
          "name": "timeout_seconds_server",
          "type": "integer",
          "description": "Timeout in seconds for server mode (0 means wait indefinitely)",
          "required": true,
          "immutable": false,
          "default": 0,
          "invariant": "Must be >= 0"
        },
        {
          "name": "output_format",
          "type": "enum",
          "values": ["plain", "json"],
          "description": "Output format preference (JSON or plain text)",
          "required": true,
          "immutable": false,
          "default": "plain"
        }
      ],
      "invariants": [
        "timeout_seconds_direct must be >= 0 (0 means indefinite wait per REQ-017)",
        "timeout_seconds_server must be >= 0 (0 means indefinite wait per REQ-017)",
        "Timeout logic must be independent for direct mode and server mode (REQ-036)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "active",
            "description": "Configuration is active and being used"
          }
        ],
        "transitions": []
      },
      "relationships": [],
      "related_requirements": ["REQ-016", "REQ-017", "REQ-018", "REQ-021", "REQ-036"],
      "related_interfaces": ["IF-021", "IF-022"]
    },
    {
      "id": "ENTITY-008",
      "name": "OperationMode",
      "description": "Represents the determined operation mode (direct or server) for a CLI command execution.",
      "glossary_terms": ["Direct Mode", "Server Mode", "Mode Detection", "Mode Override"],
      "attributes": [
        {
          "name": "mode",
          "type": "enum",
          "values": ["direct", "server"],
          "description": "Determined operation mode",
          "required": true,
          "immutable": true
        },
        {
          "name": "server_url",
          "type": "string",
          "description": "Server URL to use (only present when mode is 'server')",
          "required": false,
          "immutable": true,
          "invariant": "Must be present when mode is 'server', must be absent when mode is 'direct'"
        },
        {
          "name": "precedence_source",
          "type": "enum",
          "values": ["AILOOP_SERVER", "server_flag", "default"],
          "description": "Which source was used to determine mode (AILOOP_SERVER overrides --server flag)",
          "required": true,
          "immutable": true
        },
        {
          "name": "determined_at",
          "type": "timestamp",
          "description": "Timestamp when mode was determined",
          "required": true,
          "immutable": true
        }
      ],
      "invariants": [
        "When mode is 'server', server_url must be present and valid",
        "When mode is 'direct', server_url must be absent",
        "AILOOP_SERVER environment variable takes precedence over --server flag (REQ-003, REQ-004)",
        "If neither AILOOP_SERVER nor --server flag is present, mode must be 'direct' (REQ-002)"
      ],
      "lifecycle": {
        "states": [
          {
            "state": "determined",
            "description": "Operation mode has been determined"
          }
        ],
        "transitions": []
      },
      "relationships": [],
      "related_requirements": ["REQ-001", "REQ-002", "REQ-003", "REQ-004"],
      "related_interfaces": ["IF-001"]
    }
  ],
  "relationships": [
    {
      "from": "Message",
      "to": "Channel",
      "type": "belongs_to",
      "via": "channel",
      "description": "Messages belong to channels for isolation",
      "cardinality": "many-to-one"
    },
    {
      "from": "Message",
      "to": "Message",
      "type": "correlates_with",
      "via": "correlation_id",
      "description": "Response messages correlate with request messages via correlation_id",
      "cardinality": "one-to-one"
    },
    {
      "from": "ConnectionMapping",
      "to": "Connection",
      "type": "belongs_to",
      "via": "connection_id",
      "description": "Connection mappings belong to connections",
      "cardinality": "many-to-one"
    },
    {
      "from": "ConnectionMapping",
      "to": "Message",
      "type": "references",
      "via": "message_id",
      "description": "Connection mappings reference messages",
      "cardinality": "many-to-one"
    },
    {
      "from": "ChannelQueue",
      "to": "Channel",
      "type": "belongs_to",
      "via": "channel_name",
      "description": "Channel queues belong to channels",
      "cardinality": "one-to-one"
    },
    {
      "from": "ChannelQueue",
      "to": "Message",
      "type": "contains",
      "via": "messages",
      "description": "Channel queues contain messages",
      "cardinality": "one-to-many"
    },
    {
      "from": "PendingRequest",
      "to": "Message",
      "type": "references",
      "via": "correlation_id",
      "description": "Pending requests reference messages",
      "cardinality": "one-to-one"
    },
    {
      "from": "PendingRequest",
      "to": "Connection",
      "type": "belongs_to",
      "via": "connection_id",
      "description": "Pending requests belong to connections",
      "cardinality": "many-to-one"
    }
  ],
  "invariants": [
    {
      "id": "INV-001",
      "description": "Correlation ID uniqueness: All correlation_id values must be globally unique across all messages (REQ-027)",
      "entities": ["Message"],
      "related_requirements": ["REQ-027"]
    },
    {
      "id": "INV-002",
      "description": "Channel isolation: Messages in different channels must remain completely separate - no cross-channel access (REQ-008, REQ-029)",
      "entities": ["Message", "Channel", "ChannelQueue"],
      "related_requirements": ["REQ-008", "REQ-029"]
    },
    {
      "id": "INV-003",
      "description": "Response correlation: Response messages must have correlation_id matching an existing request message (REQ-010, REQ-012)",
      "entities": ["Message", "PendingRequest"],
      "related_requirements": ["REQ-010", "REQ-012"]
    },
    {
      "id": "INV-004",
      "description": "Connection routing: Responses must be routed back to the originating WebSocket connection (REQ-011, REQ-026)",
      "entities": ["Connection", "ConnectionMapping", "Message"],
      "related_requirements": ["REQ-011", "REQ-026"]
    },
    {
      "id": "INV-005",
      "description": "Connection tracking persistence: Connection tracking information must not be lost when connection is established (REQ-028)",
      "entities": ["Connection", "ConnectionMapping"],
      "related_requirements": ["REQ-028"]
    },
    {
      "id": "INV-006",
      "description": "Closed connection handling: Responses must not be sent to closed connections (REQ-030)",
      "entities": ["Connection", "ConnectionMapping"],
      "related_requirements": ["REQ-030"]
    },
    {
      "id": "INV-007",
      "description": "Timeout independence: Timeout logic must be independent for direct mode and server mode (REQ-036)",
      "entities": ["Configuration"],
      "related_requirements": ["REQ-036"]
    },
    {
      "id": "INV-008",
      "description": "Mode determination: AILOOP_SERVER environment variable takes precedence over --server flag (REQ-003, REQ-004)",
      "entities": ["OperationMode"],
      "related_requirements": ["REQ-003", "REQ-004"]
    },
    {
      "id": "INV-009",
      "description": "Channel validation: Channel names must pass validation rules in both direct mode and server mode (REQ-020, REQ-033)",
      "entities": ["Channel", "Message"],
      "related_requirements": ["REQ-020", "REQ-033"]
    },
    {
      "id": "INV-010",
      "description": "Output format consistency: JSON output format must be identical in both direct mode and server mode (REQ-021)",
      "entities": ["Configuration"],
      "related_requirements": ["REQ-021"]
    }
  ],
  "traceability": {
    "requirements_coverage": {
      "REQ-001": ["ENTITY-008"],
      "REQ-002": ["ENTITY-008"],
      "REQ-003": ["ENTITY-008"],
      "REQ-004": ["ENTITY-002", "ENTITY-008"],
      "REQ-005": ["ENTITY-001"],
      "REQ-006": ["ENTITY-001"],
      "REQ-007": ["ENTITY-002", "ENTITY-003"],
      "REQ-008": ["ENTITY-001", "ENTITY-004", "ENTITY-005"],
      "REQ-009": ["ENTITY-005"],
      "REQ-010": ["ENTITY-001"],
      "REQ-011": ["ENTITY-002", "ENTITY-003"],
      "REQ-012": ["ENTITY-001", "ENTITY-006"],
      "REQ-013": ["ENTITY-006"],
      "REQ-016": ["ENTITY-006", "ENTITY-007"],
      "REQ-017": ["ENTITY-006", "ENTITY-007"],
      "REQ-018": ["ENTITY-006"],
      "REQ-020": ["ENTITY-001", "ENTITY-004"],
      "REQ-021": ["ENTITY-007"],
      "REQ-027": ["ENTITY-001"],
      "REQ-028": ["ENTITY-002", "ENTITY-003"],
      "REQ-029": ["ENTITY-001", "ENTITY-004", "ENTITY-005"],
      "REQ-030": ["ENTITY-002", "ENTITY-003"],
      "REQ-033": ["ENTITY-001", "ENTITY-004"],
      "REQ-034": ["ENTITY-006"],
      "REQ-036": ["ENTITY-007"]
    },
    "component_coverage": {
      "COMP-001": ["ENTITY-008"],
      "COMP-002": ["ENTITY-001", "ENTITY-004", "ENTITY-007"],
      "COMP-003": ["ENTITY-001", "ENTITY-002", "ENTITY-004", "ENTITY-006", "ENTITY-007"],
      "COMP-004": ["ENTITY-001", "ENTITY-002", "ENTITY-003", "ENTITY-004", "ENTITY-005"],
      "COMP-005": ["ENTITY-001", "ENTITY-006"],
      "COMP-006": ["ENTITY-002", "ENTITY-003"],
      "COMP-007": ["ENTITY-004", "ENTITY-005"],
      "COMP-008": ["ENTITY-007"],
      "COMP-009": [],
      "COMP-010": []
    }
  }
}
