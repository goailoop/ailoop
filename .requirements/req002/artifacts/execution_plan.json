{
  "meta": {
    "generated_at": "2026-01-13T20:20:00.000000Z",
    "requirement_set": "req002",
    "purpose": "Dependency-aware implementation plan derived from architecture and requirements",
    "rules_applied": [
      "Build order from dependency graph",
      "No dates, teams, or tooling"
    ]
  },
  "milestones": [
    {
      "id": "MS-01",
      "name": "Foundation: Mode Detection and Configuration",
      "description": "Implement core infrastructure components required by all other features: mode detection, configuration management, and channel validation",
      "components": ["COMP-001", "COMP-007", "COMP-008"],
      "requirements": ["REQ-001", "REQ-020", "REQ-033"],
      "interfaces": ["IF-001", "IF-018", "IF-021", "IF-022"],
      "entities": ["ENTITY-004", "ENTITY-007", "ENTITY-008"],
      "dependencies": [],
      "deliverables": [
        "Mode detection logic (IF-001)",
        "Channel validation logic (IF-018)",
        "Configuration management (IF-021, IF-022)",
        "Operation mode determination"
      ],
      "acceptance_criteria": [
        "Mode detection completes within 100ms",
        "Channel validation works in both direct and server modes",
        "Configuration settings accessible for timeout and output format"
      ]
    },
    {
      "id": "MS-02",
      "name": "Direct Mode Support",
      "description": "Implement direct mode handler for CLI commands operating in local terminal without WebSocket",
      "components": ["COMP-002", "COMP-010"],
      "requirements": ["REQ-002", "REQ-020", "REQ-021", "REQ-036"],
      "interfaces": ["IF-002", "IF-003", "IF-004", "IF-025"],
      "entities": ["ENTITY-001", "ENTITY-004", "ENTITY-007"],
      "dependencies": ["MS-01"],
      "deliverables": [
        "Direct mode ask command (IF-002)",
        "Direct mode authorize command (IF-003)",
        "Direct mode say command (IF-004)",
        "Output formatting component (IF-025)",
        "Backward compatibility maintained"
      ],
      "acceptance_criteria": [
        "Direct mode commands work without AILOOP_SERVER env var",
        "Questions displayed in local terminal within 1 second",
        "JSON output format consistent",
        "Channel validation applied"
      ]
    },
    {
      "id": "MS-03",
      "name": "Server Mode Core: Connection and Message Infrastructure",
      "description": "Implement WebSocket connection management, message correlation, and connection tracking infrastructure",
      "components": ["COMP-003", "COMP-005", "COMP-006"],
      "requirements": ["REQ-004", "REQ-005", "REQ-007", "REQ-027", "REQ-028", "REQ-035"],
      "interfaces": ["IF-005", "IF-013", "IF-015", "IF-016", "IF-017"],
      "entities": ["ENTITY-001", "ENTITY-002", "ENTITY-003", "ENTITY-006"],
      "dependencies": ["MS-01"],
      "deliverables": [
        "WebSocket connection establishment (IF-005)",
        "Correlation ID generation (IF-013)",
        "Connection mapping recording (IF-015)",
        "Connection lookup (IF-016)",
        "Connection mapping removal (IF-017)",
        "URL protocol conversion (http/https to ws/wss)"
      ],
      "acceptance_criteria": [
        "WebSocket connections established successfully",
        "Correlation IDs are globally unique UUIDs",
        "Connection mappings recorded and persisted",
        "URL validation prevents invalid connections"
      ]
    },
    {
      "id": "MS-04",
      "name": "Server Mode Client: Message Transmission",
      "description": "Implement client-side message creation, serialization, and transmission via WebSocket",
      "components": ["COMP-003", "COMP-005"],
      "requirements": ["REQ-006", "REQ-020", "REQ-033"],
      "interfaces": ["IF-006", "IF-008"],
      "entities": ["ENTITY-001", "ENTITY-004"],
      "dependencies": ["MS-03"],
      "deliverables": [
        "Message creation with correlation_id (IF-006)",
        "Message serialization to JSON (IF-006)",
        "Message transmission via WebSocket (IF-006)",
        "Pending request tracking (IF-008)",
        "Channel validation before sending"
      ],
      "acceptance_criteria": [
        "Messages serialized to valid JSON",
        "Messages arrive at server within 1 second",
        "Channel validation applied before transmission",
        "Pending requests tracked correctly"
      ]
    },
    {
      "id": "MS-05",
      "name": "Server Mode Server: Message Reception and Queuing",
      "description": "Implement server-side message reception, validation, connection tracking, and channel queuing",
      "components": ["COMP-004", "COMP-006", "COMP-007"],
      "requirements": ["REQ-007", "REQ-008", "REQ-029", "REQ-031"],
      "interfaces": ["IF-009", "IF-010", "IF-019", "IF-020"],
      "entities": ["ENTITY-001", "ENTITY-002", "ENTITY-003", "ENTITY-004", "ENTITY-005"],
      "dependencies": ["MS-03", "MS-04"],
      "deliverables": [
        "Connection establishment event handling (IF-009)",
        "Message reception and validation (IF-010)",
        "Channel-specific message queuing (IF-019)",
        "Channel queue retrieval (IF-020)",
        "Message format validation",
        "Channel isolation enforcement"
      ],
      "acceptance_criteria": [
        "Messages received and validated",
        "Messages enqueued in correct channel queues",
        "Channel isolation maintained",
        "Invalid messages rejected"
      ]
    },
    {
      "id": "MS-06",
      "name": "Server Mode Server: Message Display and Response Creation",
      "description": "Implement server terminal UI message display and response message creation with correlation",
      "components": ["COMP-004", "COMP-005"],
      "requirements": ["REQ-009", "REQ-010"],
      "interfaces": ["IF-011"],
      "entities": ["ENTITY-001"],
      "dependencies": ["MS-05"],
      "deliverables": [
        "Message display in terminal UI (within 500ms)",
        "Response message creation with matching correlation_id (IF-011)",
        "Human response collection from terminal UI"
      ],
      "acceptance_criteria": [
        "Messages displayed in terminal UI within 500ms",
        "Message content matches exactly",
        "Response correlation_id matches request id"
      ]
    },
    {
      "id": "MS-07",
      "name": "Server Mode Server: Response Routing",
      "description": "Implement response routing back to originating WebSocket connections using connection tracking",
      "components": ["COMP-004", "COMP-006"],
      "requirements": ["REQ-011", "REQ-026", "REQ-030"],
      "interfaces": ["IF-011", "IF-012", "IF-016"],
      "entities": ["ENTITY-001", "ENTITY-002", "ENTITY-003"],
      "dependencies": ["MS-05", "MS-06"],
      "deliverables": [
        "Response routing to originating connections (IF-011)",
        "Connection closure event handling (IF-012)",
        "Closed connection detection and handling",
        "Response routing accuracy verification"
      ],
      "acceptance_criteria": [
        "Responses routed to correct originating connections",
        "No responses sent to closed connections",
        "Connection closure handled gracefully"
      ]
    },
    {
      "id": "MS-08",
      "name": "Server Mode Client: Response Reception and Matching",
      "description": "Implement client-side response waiting, correlation matching, and timeout handling",
      "components": ["COMP-003", "COMP-005", "COMP-008"],
      "requirements": ["REQ-012", "REQ-013", "REQ-016", "REQ-017", "REQ-018", "REQ-034"],
      "interfaces": ["IF-007", "IF-014"],
      "entities": ["ENTITY-001", "ENTITY-006", "ENTITY-007"],
      "dependencies": ["MS-04", "MS-07"],
      "deliverables": [
        "Response waiting with correlation matching (IF-007)",
        "Response matching to pending requests (IF-014)",
        "Timeout application from configuration (finite and indefinite)",
        "Timeout error handling",
        "Unmatched response handling"
      ],
      "acceptance_criteria": [
        "Responses matched to correct pending requests",
        "Finite timeout applied correctly (within 100ms tolerance)",
        "Indefinite wait when timeout_seconds=0",
        "Timeout errors handled with appropriate messages"
      ]
    },
    {
      "id": "MS-09",
      "name": "Error Handling and Validation",
      "description": "Implement comprehensive error handling, validation, and security measures",
      "components": ["COMP-003", "COMP-004", "COMP-009"],
      "requirements": ["REQ-014", "REQ-025", "REQ-031", "REQ-032", "REQ-035"],
      "interfaces": ["IF-023", "IF-024"],
      "entities": [],
      "dependencies": ["MS-03", "MS-05"],
      "deliverables": [
        "Connection error formatting (IF-023)",
        "Timeout error formatting (IF-024)",
        "No fallback to direct mode on connection failure",
        "Message format validation",
        "Error message security (no sensitive info exposure)",
        "URL validation"
      ],
      "acceptance_criteria": [
        "Connection errors formatted with URL and error type",
        "Error messages do not expose sensitive information",
        "No fallback to direct mode",
        "Invalid messages and URLs rejected"
      ]
    },
    {
      "id": "MS-10",
      "name": "Command Integration: Ask, Authorize, Say",
      "description": "Integrate server mode support for ask, authorize, and say commands with complete request-response cycles",
      "components": ["COMP-003", "COMP-010"],
      "requirements": ["REQ-022", "REQ-023", "REQ-024", "REQ-021"],
      "interfaces": ["IF-006", "IF-007", "IF-025"],
      "entities": ["ENTITY-001", "ENTITY-006", "ENTITY-007"],
      "dependencies": ["MS-08", "MS-09"],
      "deliverables": [
        "Server mode ask command integration",
        "Server mode authorize command integration",
        "Server mode say command integration",
        "Consistent JSON output format",
        "Complete request-response cycles"
      ],
      "acceptance_criteria": [
        "Ask command works in server mode with response",
        "Authorize command works with approval/denial",
        "Say command completes immediately without waiting",
        "JSON output format consistent across modes"
      ]
    },
    {
      "id": "MS-11",
      "name": "Quality and Negative Requirements",
      "description": "Implement negative requirements and quality attributes: channel isolation, correlation uniqueness, connection tracking persistence, timeout independence",
      "components": ["COMP-002", "COMP-003", "COMP-004", "COMP-005", "COMP-006", "COMP-007", "COMP-008"],
      "requirements": ["REQ-025", "REQ-026", "REQ-027", "REQ-028", "REQ-029", "REQ-030", "REQ-033", "REQ-036"],
      "interfaces": [],
      "entities": ["ENTITY-001", "ENTITY-002", "ENTITY-003", "ENTITY-004", "ENTITY-005", "ENTITY-006", "ENTITY-007"],
      "dependencies": ["MS-02", "MS-08", "MS-09", "MS-10"],
      "deliverables": [
        "Channel isolation enforcement",
        "Correlation ID global uniqueness",
        "Connection tracking persistence",
        "Response routing accuracy",
        "Closed connection handling",
        "Timeout logic independence",
        "No fallback to direct mode"
      ],
      "acceptance_criteria": [
        "All negative requirements satisfied",
        "Quality attributes verified",
        "No unwanted behaviors occur"
      ]
    }
  ],
  "dependency_graph": {
    "milestone_dependencies": [
      {
        "from": "MS-02",
        "to": "MS-01",
        "type": "depends_on",
        "reason": "Direct mode requires mode detection and configuration"
      },
      {
        "from": "MS-03",
        "to": "MS-01",
        "type": "depends_on",
        "reason": "Server mode core requires mode detection and channel validation"
      },
      {
        "from": "MS-04",
        "to": "MS-03",
        "type": "depends_on",
        "reason": "Message transmission requires connection and correlation infrastructure"
      },
      {
        "from": "MS-05",
        "to": "MS-03",
        "type": "depends_on",
        "reason": "Message reception requires connection infrastructure"
      },
      {
        "from": "MS-05",
        "to": "MS-04",
        "type": "depends_on",
        "reason": "Server message reception requires client message transmission"
      },
      {
        "from": "MS-06",
        "to": "MS-05",
        "type": "depends_on",
        "reason": "Message display requires messages to be queued"
      },
      {
        "from": "MS-07",
        "to": "MS-05",
        "type": "depends_on",
        "reason": "Response routing requires connection tracking"
      },
      {
        "from": "MS-07",
        "to": "MS-06",
        "type": "depends_on",
        "reason": "Response routing requires response messages to be created"
      },
      {
        "from": "MS-08",
        "to": "MS-04",
        "type": "depends_on",
        "reason": "Response reception requires message transmission"
      },
      {
        "from": "MS-08",
        "to": "MS-07",
        "type": "depends_on",
        "reason": "Response reception requires responses to be routed"
      },
      {
        "from": "MS-09",
        "to": "MS-03",
        "type": "depends_on",
        "reason": "Error handling requires connection infrastructure"
      },
      {
        "from": "MS-09",
        "to": "MS-05",
        "type": "depends_on",
        "reason": "Error handling requires message reception"
      },
      {
        "from": "MS-10",
        "to": "MS-08",
        "type": "depends_on",
        "reason": "Command integration requires response reception"
      },
      {
        "from": "MS-10",
        "to": "MS-09",
        "type": "depends_on",
        "reason": "Command integration requires error handling"
      },
      {
        "from": "MS-11",
        "to": "MS-02",
        "type": "depends_on",
        "reason": "Quality requirements verify direct mode behavior"
      },
      {
        "from": "MS-11",
        "to": "MS-08",
        "type": "depends_on",
        "reason": "Quality requirements verify server mode behavior"
      },
      {
        "from": "MS-11",
        "to": "MS-09",
        "type": "depends_on",
        "reason": "Quality requirements verify error handling"
      },
      {
        "from": "MS-11",
        "to": "MS-10",
        "type": "depends_on",
        "reason": "Quality requirements verify command integration"
      }
    ],
    "parallel_opportunities": [
      {
        "milestones": ["MS-02", "MS-03"],
        "reason": "Direct mode and server mode core can be developed in parallel after MS-01",
        "constraints": "Both require MS-01 foundation"
      },
      {
        "milestones": ["MS-05", "MS-08"],
        "reason": "Server message reception and client response reception can be developed in parallel after MS-04",
        "constraints": "MS-05 requires MS-04 for message transmission, MS-08 requires MS-04 for pending requests"
      }
    ]
  },
  "build_order": [
    "MS-01",
    "MS-02",
    "MS-03",
    "MS-04",
    "MS-05",
    "MS-06",
    "MS-07",
    "MS-08",
    "MS-09",
    "MS-10",
    "MS-11"
  ],
  "risk_assessment": {
    "high_risk_areas": [
      {
        "milestone": "MS-03",
        "risk": "WebSocket connection management complexity",
        "mitigation": "Implement connection state machine carefully, handle edge cases"
      },
      {
        "milestone": "MS-07",
        "risk": "Response routing accuracy critical for correctness",
        "mitigation": "Comprehensive testing of connection tracking and correlation matching"
      },
      {
        "milestone": "MS-08",
        "risk": "Timeout handling complexity with finite and indefinite waits",
        "mitigation": "Clear separation of timeout logic, thorough testing of edge cases"
      }
    ],
    "medium_risk_areas": [
      {
        "milestone": "MS-05",
        "risk": "Channel isolation must be perfect",
        "mitigation": "Strict channel validation and queue separation"
      },
      {
        "milestone": "MS-09",
        "risk": "Error message security - must not expose sensitive info",
        "mitigation": "Careful error message formatting, security review"
      }
    ]
  },
  "traceability": {
    "requirements_coverage": {
      "REQ-001": ["MS-01"],
      "REQ-002": ["MS-02"],
      "REQ-003": ["MS-03"],
      "REQ-004": ["MS-03"],
      "REQ-005": ["MS-03"],
      "REQ-006": ["MS-04"],
      "REQ-007": ["MS-05"],
      "REQ-008": ["MS-05"],
      "REQ-009": ["MS-06"],
      "REQ-010": ["MS-06"],
      "REQ-011": ["MS-07"],
      "REQ-012": ["MS-08"],
      "REQ-013": ["MS-08"],
      "REQ-014": ["MS-09"],
      "REQ-016": ["MS-08"],
      "REQ-017": ["MS-08"],
      "REQ-018": ["MS-08"],
      "REQ-020": ["MS-01", "MS-02"],
      "REQ-021": ["MS-02", "MS-10"],
      "REQ-022": ["MS-10"],
      "REQ-023": ["MS-10"],
      "REQ-024": ["MS-10"],
      "REQ-025": ["MS-09", "MS-11"],
      "REQ-026": ["MS-07", "MS-11"],
      "REQ-027": ["MS-03", "MS-11"],
      "REQ-028": ["MS-03", "MS-11"],
      "REQ-029": ["MS-05", "MS-11"],
      "REQ-030": ["MS-07", "MS-11"],
      "REQ-031": ["MS-05", "MS-09"],
      "REQ-032": ["MS-09"],
      "REQ-033": ["MS-01", "MS-11"],
      "REQ-034": ["MS-08", "MS-11"],
      "REQ-035": ["MS-03", "MS-09"],
      "REQ-036": ["MS-02", "MS-08", "MS-11"]
    },
    "component_coverage": {
      "COMP-001": ["MS-01"],
      "COMP-002": ["MS-02", "MS-11"],
      "COMP-003": ["MS-03", "MS-04", "MS-08", "MS-09", "MS-10", "MS-11"],
      "COMP-004": ["MS-05", "MS-06", "MS-07", "MS-09", "MS-11"],
      "COMP-005": ["MS-03", "MS-04", "MS-06", "MS-08", "MS-11"],
      "COMP-006": ["MS-03", "MS-05", "MS-07", "MS-11"],
      "COMP-007": ["MS-01", "MS-05", "MS-11"],
      "COMP-008": ["MS-01", "MS-08", "MS-11"],
      "COMP-009": ["MS-09"],
      "COMP-010": ["MS-02", "MS-10"]
    },
    "interface_coverage": {
      "IF-001": ["MS-01"],
      "IF-002": ["MS-02"],
      "IF-003": ["MS-02"],
      "IF-004": ["MS-02"],
      "IF-005": ["MS-03"],
      "IF-006": ["MS-04", "MS-10"],
      "IF-007": ["MS-08", "MS-10"],
      "IF-008": ["MS-04"],
      "IF-009": ["MS-05"],
      "IF-010": ["MS-05"],
      "IF-011": ["MS-06", "MS-07"],
      "IF-012": ["MS-07"],
      "IF-013": ["MS-03"],
      "IF-014": ["MS-08"],
      "IF-015": ["MS-03", "MS-05"],
      "IF-016": ["MS-03", "MS-07"],
      "IF-017": ["MS-03"],
      "IF-018": ["MS-01"],
      "IF-019": ["MS-05"],
      "IF-020": ["MS-05"],
      "IF-021": ["MS-01", "MS-08"],
      "IF-022": ["MS-01"],
      "IF-023": ["MS-09"],
      "IF-024": ["MS-09"],
      "IF-025": ["MS-02", "MS-10"]
    }
  }
}
