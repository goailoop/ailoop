{
  "verification": [
    {
      "requirement_id": "REQ-001",
      "method": "test",
      "acceptance_criteria": [
        "Execute 'ailoop ask \"test\"' without AILOOP_SERVER env var set",
        "Verify system operates in direct mode (question displayed in local terminal)",
        "Set AILOOP_SERVER=http://localhost:8080 and execute 'ailoop ask \"test\"'",
        "Verify system operates in server mode (attempts WebSocket connection)",
        "Confirm mode detection completes within 100ms of command execution"
      ]
    },
    {
      "requirement_id": "REQ-002",
      "method": "test",
      "acceptance_criteria": [
        "Execute 'ailoop ask \"What is your name?\"' without AILOOP_SERVER env var",
        "Verify question is displayed in local terminal within 1 second",
        "Provide response and verify it is captured and returned to agent",
        "Confirm no WebSocket connection attempt is made",
        "Verify command completes in direct mode"
      ]
    },
    {
      "requirement_id": "REQ-003",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER=http://localhost:8080 environment variable",
        "Execute 'ailoop ask \"test question\"' command",
        "Verify system attempts WebSocket connection to ws://localhost:8080",
        "Confirm server mode is activated (no local terminal prompt)",
        "Verify message is sent via WebSocket connection"
      ]
    },
    {
      "requirement_id": "REQ-004",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER=http://localhost:8080 and execute command",
        "Verify URL is converted from http:// to ws:// protocol",
        "Set AILOOP_SERVER=https://example.com:443 and execute command",
        "Verify URL is converted from https:// to wss:// protocol",
        "Confirm WebSocket connection is established successfully"
      ]
    },
    {
      "requirement_id": "REQ-005",
      "method": "test",
      "acceptance_criteria": [
        "Send question message via WebSocket client",
        "Verify Message object contains correlation_id field",
        "Verify correlation_id is UUID format (8-4-4-4-12 hexadecimal)",
        "Send authorization message and verify unique correlation_id",
        "Send notification message and verify unique correlation_id",
        "Confirm all correlation_ids are globally unique (no duplicates across 1000 messages)"
      ]
    },
    {
      "requirement_id": "REQ-006",
      "method": "test",
      "acceptance_criteria": [
        "Create Message object with question content",
        "Establish WebSocket connection to server",
        "Verify Message is serialized to valid JSON format",
        "Verify JSON message is sent via WebSocket connection",
        "Confirm message arrives at server within 1 second",
        "Verify server can parse received JSON message"
      ]
    },
    {
      "requirement_id": "REQ-007",
      "method": "test",
      "acceptance_criteria": [
        "Send message from WebSocket client to server",
        "Verify server records mapping between message and connection",
        "Send second message from different connection",
        "Verify server maintains separate mappings for each connection",
        "Confirm mapping persists until response is sent or connection closes"
      ]
    },
    {
      "requirement_id": "REQ-008",
      "method": "test",
      "acceptance_criteria": [
        "Send message with channel='test-channel' to server",
        "Verify message is added to queue for 'test-channel'",
        "Send message with channel='other-channel' to server",
        "Verify message is added to queue for 'other-channel'",
        "Verify messages in different channels are isolated (cannot access cross-channel)",
        "Confirm channel isolation is maintained"
      ]
    },
    {
      "requirement_id": "REQ-009",
      "method": "inspection",
      "acceptance_criteria": [
        "Enqueue question message in server channel queue",
        "Verify question text appears in server terminal UI within 500ms",
        "Enqueue authorization message and verify it appears in terminal UI",
        "Enqueue notification message and verify it appears in terminal UI",
        "Confirm message content matches exactly what was sent",
        "Verify messages appear in order of enqueueing"
      ]
    },
    {
      "requirement_id": "REQ-010",
      "method": "test",
      "acceptance_criteria": [
        "Send question message with id='msg-123' to server",
        "Human provides response in server terminal",
        "Verify response Message has correlation_id='msg-123'",
        "Send authorization message with id='msg-456'",
        "Human provides authorization decision",
        "Verify response Message has correlation_id='msg-456'",
        "Confirm correlation_id matches original request id exactly"
      ]
    },
    {
      "requirement_id": "REQ-011",
      "method": "test",
      "acceptance_criteria": [
        "Send message from WebSocket connection A",
        "Create response with matching correlation_id",
        "Verify server uses connection tracking to identify connection A",
        "Verify response is sent via connection A (not connection B)",
        "Send message from different connection B",
        "Verify response for B is sent via connection B",
        "Confirm responses are routed to correct originating connections"
      ]
    },
    {
      "requirement_id": "REQ-012",
      "method": "test",
      "acceptance_criteria": [
        "Send request with correlation_id='req-1'",
        "Send request with correlation_id='req-2'",
        "Receive response with correlation_id='req-1'",
        "Verify response is matched to first request (req-1)",
        "Receive response with correlation_id='req-2'",
        "Verify response is matched to second request (req-2)",
        "Confirm map lookup correctly matches correlation_ids",
        "Verify unmatched correlation_id is handled appropriately"
      ]
    },
    {
      "requirement_id": "REQ-013",
      "method": "test",
      "acceptance_criteria": [
        "Send question message to server",
        "Verify client waits for response with matching correlation_id",
        "Set timeout_seconds=5 in config and send question",
        "Verify timeout rules (REQ-016) are applied (timeout set to 5 seconds)",
        "Set timeout_seconds=0 in config and send question",
        "Verify client waits indefinitely (no timeout after 60 seconds) per REQ-017",
        "Confirm timeout rules (REQ-016/REQ-017) are applied correctly during waiting"
      ]
    },
    {
      "requirement_id": "REQ-014",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER=http://unreachable:8080",
        "Execute 'ailoop ask \"test\"' command",
        "Verify error message format: 'Failed to connect to server at http://unreachable:8080: {error_type}. Ensure server is running and accessible.'",
        "Verify error_type is specific (connection refused, network unreachable, etc.)",
        "Verify command exits with error code 1",
        "Verify system does NOT fall back to direct mode",
        "Confirm error message includes URL and actionable guidance"
      ]
    },
    {
      "requirement_id": "REQ-016",
      "method": "test",
      "acceptance_criteria": [
        "Set timeout_seconds=10 in configuration file",
        "Send question message in server mode",
        "Verify timeout of 10 seconds is applied",
        "Wait 11 seconds without response",
        "Verify timeout error occurs at 10 seconds (within 100ms tolerance)",
        "Set timeout_seconds=30 and verify 30 second timeout is applied",
        "Confirm timeout_seconds from config file is used correctly"
      ]
    },
    {
      "requirement_id": "REQ-017",
      "method": "test",
      "acceptance_criteria": [
        "Set timeout_seconds=0 in configuration file",
        "Send question message in server mode",
        "Wait 60 seconds without response",
        "Verify no timeout error occurs",
        "Wait 300 seconds without response",
        "Verify still no timeout error occurs",
        "Confirm system waits indefinitely when timeout_seconds=0"
      ]
    },
    {
      "requirement_id": "REQ-018",
      "method": "test",
      "acceptance_criteria": [
        "Set timeout_seconds=5 in configuration",
        "Send question message and wait 6 seconds",
        "Verify timeout error message is displayed",
        "Verify command exits with error code 1",
        "Verify timeout occurs within 100ms of configured timeout",
        "Confirm timeout error is clear and actionable"
      ]
    },
    {
      "requirement_id": "REQ-020",
      "method": "test",
      "acceptance_criteria": [
        "Execute command with --channel invalid-channel! in direct mode",
        "Verify channel validation error occurs",
        "Execute command with --channel invalid-channel! in server mode",
        "Verify same channel validation error occurs",
        "Execute with valid channel in both modes",
        "Confirm validation rules are identical in both modes"
      ]
    },
    {
      "requirement_id": "REQ-021",
      "method": "test",
      "acceptance_criteria": [
        "Execute 'ailoop ask \"test\"' --json in direct mode",
        "Capture JSON output structure",
        "Set AILOOP_SERVER and execute 'ailoop ask \"test\"' --json in server mode",
        "Capture JSON output structure",
        "Compare JSON structures and verify they are identical",
        "Verify same fields are present in both modes",
        "Confirm JSON format is consistent"
      ]
    },
    {
      "requirement_id": "REQ-022",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER and execute 'ailoop ask \"What is the answer?\"'",
        "Verify question is sent to server via WebSocket",
        "Provide response in server terminal",
        "Verify response is received by client",
        "Verify response is returned to agent",
        "Confirm complete request-response cycle works",
        "Verify timeout rules are applied during wait"
      ]
    },
    {
      "requirement_id": "REQ-023",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER and execute 'ailoop authorize \"Deploy to prod\"'",
        "Verify authorization request is sent to server",
        "Provide 'authorized' response in server terminal",
        "Verify approval decision is received by client",
        "Verify command exits with code 0 (authorized)",
        "Provide 'denied' response in server terminal",
        "Verify denial decision is received and command exits with code 1",
        "Confirm timeout rules are applied during wait"
      ]
    },
    {
      "requirement_id": "REQ-024",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER and execute 'ailoop say \"Notification\"'",
        "Verify notification is sent to server via WebSocket",
        "Verify command completes immediately (within 1 second)",
        "Verify no response waiting occurs",
        "Verify notification appears in server terminal UI",
        "Confirm command exits with success code 0"
      ]
    },
    {
      "requirement_id": "REQ-025",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER=http://unreachable:8080",
        "Execute 'ailoop ask \"test\"' command",
        "Verify connection fails",
        "Verify system does NOT fall back to direct mode",
        "Verify error is reported and command fails",
        "Confirm no local terminal prompt appears"
      ]
    },
    {
      "requirement_id": "REQ-026",
      "method": "test",
      "acceptance_criteria": [
        "Send request from connection A with correlation_id='req-a'",
        "Send request from connection B with correlation_id='req-b'",
        "Send response for req-a",
        "Verify response is routed to connection A (not B)",
        "Send response for req-b",
        "Verify response is routed to connection B (not A)",
        "Confirm responses never go to wrong connections"
      ]
    },
    {
      "requirement_id": "REQ-027",
      "method": "test",
      "acceptance_criteria": [
        "Generate 1000 messages and collect all correlation_ids",
        "Verify all correlation_ids are unique (no duplicates)",
        "Check correlation_id format is valid UUID",
        "Verify correlation_id uniqueness across different connections",
        "Verify correlation_id uniqueness across different channels",
        "Confirm no duplicate correlation_ids are generated"
      ]
    },
    {
      "requirement_id": "REQ-028",
      "method": "test",
      "acceptance_criteria": [
        "Establish WebSocket connection and send message",
        "Verify connection tracking information is recorded",
        "Send response and verify connection tracking is used",
        "Establish new connection and verify tracking is separate",
        "Verify connection tracking persists until connection closes",
        "Confirm no connection tracking information is lost"
      ]
    },
    {
      "requirement_id": "REQ-029",
      "method": "test",
      "acceptance_criteria": [
        "Send message with channel='channel-a' to server",
        "Verify message is processed in channel-a queue only",
        "Send message with channel='channel-b' to server",
        "Verify message is processed in channel-b queue only",
        "Verify channel-a messages are not accessible from channel-b",
        "Verify channel-b messages are not accessible from channel-a",
        "Confirm channel isolation is maintained"
      ]
    },
    {
      "requirement_id": "REQ-030",
      "method": "test",
      "acceptance_criteria": [
        "Send request from WebSocket connection",
        "Close WebSocket connection before response is ready",
        "Verify server detects connection is closed",
        "Verify server does NOT attempt to send response to closed connection",
        "Verify no error occurs from sending to closed connection",
        "Confirm closed connections are handled gracefully"
      ]
    },
    {
      "requirement_id": "REQ-031",
      "method": "test",
      "acceptance_criteria": [
        "Send malformed JSON message via WebSocket",
        "Verify server rejects message with validation error",
        "Send message with missing required fields",
        "Verify server rejects message",
        "Send message with invalid field types",
        "Verify server rejects message",
        "Confirm only valid messages are processed"
      ]
    },
    {
      "requirement_id": "REQ-032",
      "method": "inspection",
      "acceptance_criteria": [
        "Trigger connection error and capture error message",
        "Verify error message does NOT contain internal IP addresses",
        "Verify error message does NOT contain connection IDs",
        "Verify error message does NOT contain internal state information",
        "Verify error message contains only user-facing information (URL, error type, guidance)",
        "Confirm sensitive details are not exposed"
      ]
    },
    {
      "requirement_id": "REQ-033",
      "method": "test",
      "acceptance_criteria": [
        "Attempt to send message with invalid channel name in server mode",
        "Verify channel validation error occurs",
        "Attempt to send message with valid channel name in server mode",
        "Verify message is accepted",
        "Compare validation behavior with direct mode",
        "Confirm channel validation is identical in both modes"
      ]
    },
    {
      "requirement_id": "REQ-034",
      "method": "test",
      "acceptance_criteria": [
        "Send request with correlation_id='req-1'",
        "Receive response with correlation_id='req-999' (non-existent)",
        "Verify system detects unmatched correlation_id",
        "Verify system logs warning or handles appropriately",
        "Verify system does NOT crash or fail silently",
        "Confirm orphaned responses are detected and handled"
      ]
    },
    {
      "requirement_id": "REQ-035",
      "method": "test",
      "acceptance_criteria": [
        "Set AILOOP_SERVER=invalid-url-format",
        "Execute command and verify URL validation error",
        "Set AILOOP_SERVER=http://",
        "Execute command and verify URL validation error",
        "Set AILOOP_SERVER=not-a-url",
        "Execute command and verify URL validation error",
        "Verify invalid URLs are rejected before connection attempt",
        "Confirm URL validation prevents connection to invalid destinations"
      ]
    },
    {
      "requirement_id": "REQ-036",
      "method": "test",
      "acceptance_criteria": [
        "Set timeout_seconds=10 in config",
        "Execute ask command in direct mode and verify timeout behavior",
        "Execute ask command in server mode and verify timeout behavior",
        "Verify timeout logic is independent for each mode",
        "Change timeout in config and verify each mode uses its own timeout",
        "Confirm timeout handling does not mix between modes"
      ]
    }
  ]
}